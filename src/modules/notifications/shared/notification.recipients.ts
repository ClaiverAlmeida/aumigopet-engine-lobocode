import { Injectable } from '@nestjs/common';
import { PrismaService } from '../../../shared/prisma/prisma.service';
import { RecipientType, RecipientRule } from './notification.types';

/**
 * ğŸ‘¥ SISTEMA DE DESTINATÃRIOS DE NOTIFICAÃ‡ÃƒO FLEXÃVEL
 *
 * Gerencia quem deve receber cada tipo de notificaÃ§Ã£o baseado em regras de negÃ³cio.
 * Suporta diferentes tipos de destinatÃ¡rios para diferentes cenÃ¡rios.
 */
@Injectable()
export class NotificationRecipientsService {
  constructor(private prisma: PrismaService) {}

  /**
   * ğŸ¯ OBTÃ‰M DESTINATÃRIOS BASEADO NO TIPO E REGRAS
   */
  async getRecipients(
    companyId: string,
    recipientType: RecipientType,
    rule?: RecipientRule,
  ): Promise<string[]> {
    switch (recipientType) {
      case 'ALL':
        return this.getAllUsers(companyId);

      case 'ADMINS_ONLY':
        return this.getAdminsOnly(companyId);

      case 'SUPERVISORS_ONLY':
        return this.getSupervisorsOnly(companyId);

      case 'ADMINS_AND_SUPERVISORS':
        return this.getAdminsAndSupervisors(companyId);

      case 'ACTIVE_SUPERVISORS':
        return this.getActiveSupervisors(companyId);

      case 'ACTIVE_SUPERVISORS_AND_ADMINS':
        return this.getActiveSupervisorsAndAdmins(companyId);

      case 'ACTIVE_SUPERVISORS_AND_ADMINS_AND_HR':
        return this.getActiveSupervisorsAndAdminsAndHR(companyId);

      case 'HR_ONLY':
        return this.getHROnly(companyId);

      case 'HR_AND_ADMINS':
        return this.getHRAndAdmins(companyId);

      case 'GUARD_ONLY':
        return this.getGuardOnly(rule?.guardId);

      case 'GUARD_AND_SUPERVISORS':
        return this.getGuardAndSupervisors(companyId, rule?.guardId);

      case 'GUARD_AND_ADMINS':
        return this.getGuardAndAdmins(companyId, rule?.guardId);

      case 'GUARD_AND_ACTIVE_SUPERVISORS':
        return this.getGuardAndActiveSupervisors(companyId, rule?.guardId);

      case 'GUARD_AND_ACTIVE_SUPERVISORS_AND_ADMINS':
        return this.getGuardAndActiveSupervisorsAndAdmins(companyId, rule?.guardId);

      case 'SPECIFIC_USERS':
        return rule?.userIds || [];

      default:
        console.warn(`Tipo de destinatÃ¡rio nÃ£o reconhecido: ${recipientType}`);
        return [];
    }
  }

  // ============================================================================
  // ğŸ”§ MÃ‰TODOS PRIVADOS PARA DIFERENTES TIPOS DE DESTINATÃRIOS
  // ============================================================================

  /**
   * ğŸ‘¥ TODOS OS USUÃRIOS DA EMPRESA
   */
  private async getAllUsers(companyId: string): Promise<string[]> {
    const users = await this.prisma.user.findMany({
      where: {
        companyId,
        status: 'ACTIVE',
        deletedAt: null,
      },
      select: { id: true },
    });
    return users.map((user) => user.id);
  }

  /**
   * ğŸ‘‘ APENAS ADMINISTRADORES
   */
  private async getAdminsOnly(companyId: string): Promise<string[]> {
    const users = await this.prisma.user.findMany({
      where: {
        companyId,
        role: 'ADMIN',
        status: 'ACTIVE',
        deletedAt: null,
      },
      select: { id: true },
    });
    return users.map((user) => user.id);
  }

  /**
   * ğŸ‘¨â€ğŸ’¼ APENAS SUPERVISORES
   */
  private async getSupervisorsOnly(companyId: string): Promise<string[]> {
    const users = await this.prisma.user.findMany({
      where: {
        companyId,
        role: 'SUPERVISOR',
        status: 'ACTIVE',
        deletedAt: null,
      },
      select: { id: true },
    });
    return users.map((user) => user.id);
  }

  /**
   * ğŸ‘‘ğŸ‘¨â€ğŸ’¼ ADMINISTRADORES E SUPERVISORES
   */
  private async getAdminsAndSupervisors(companyId: string): Promise<string[]> {
    const users = await this.prisma.user.findMany({
      where: {
        companyId,
        role: { in: ['ADMIN', 'SUPERVISOR'] },
        status: 'ACTIVE',
        deletedAt: null,
      },
      select: { id: true },
    });
    return users.map((user) => user.id);
  }

  /**
   * ğŸ”„ SUPERVISORES EM TURNO ATIVO
   */
  private async getActiveSupervisors(companyId: string): Promise<string[]> {
    const activeShifts = await this.prisma.shift.findMany({
      where: {
        user: {
          companyId,
          role: 'SUPERVISOR',
          status: 'ACTIVE',
          deletedAt: null,
        },
        status: { not: 'COMPLETED' },
        endTime: null,
      },
      select: { userId: true },
    });
    return activeShifts.map((shift) => shift.userId);
  }

  /**
   * ğŸ”„ğŸ‘‘ SUPERVISORES ATIVOS + ADMINISTRADORES
   */
  private async getActiveSupervisorsAndAdmins(
    companyId: string,
  ): Promise<string[]> {
    const [activeSupervisors, admins] = await Promise.all([
      this.getActiveSupervisors(companyId),
      this.getAdminsOnly(companyId),
    ]);
    return Array.from(new Set([...activeSupervisors, ...admins]));
  }

  /**
   * ğŸ”„ğŸ‘‘ğŸ‘” SUPERVISORES ATIVOS + ADMINISTRADORES + RH
   */
  private async getActiveSupervisorsAndAdminsAndHR(
    companyId: string,
  ): Promise<string[]> {
    const [activeSupervisors, admins, hr] = await Promise.all([
      this.getActiveSupervisors(companyId),
      this.getAdminsOnly(companyId),
      this.getHROnly(companyId),
    ]);
    return Array.from(new Set([...activeSupervisors, ...admins, ...hr]));
  }

  /**
   * ğŸ‘” APENAS RH
   */
  private async getHROnly(companyId: string): Promise<string[]> {
    const users = await this.prisma.user.findMany({
      where: {
        companyId,
        role: 'HR',
        status: 'ACTIVE',
        deletedAt: null,
      },
      select: { id: true },
    });
    return users.map((user) => user.id);
  }

  /**
   * ğŸ‘”ğŸ‘‘ RH + ADMINISTRADORES
   */
  private async getHRAndAdmins(companyId: string): Promise<string[]> {
    const [hr, admins] = await Promise.all([
      this.getHROnly(companyId),
      this.getAdminsOnly(companyId),
    ]);
    return Array.from(new Set([...hr, ...admins]));
  }

  /**
   * ğŸ›¡ï¸ APENAS GUARDA ESPECÃFICO
   */
  private async getGuardOnly(guardId?: string): Promise<string[]> {
    if (!guardId) return [];
    return [guardId];
  }

  /**
   * ğŸ›¡ï¸ğŸ‘¨â€ğŸ’¼ GUARDA + SUPERVISORES
   */
  private async getGuardAndSupervisors(
    companyId: string,
    guardId?: string,
  ): Promise<string[]> {
    const [guard, supervisors] = await Promise.all([
      this.getGuardOnly(guardId),
      this.getSupervisorsOnly(companyId),
    ]);
    return Array.from(new Set([...guard, ...supervisors]));
  }

  /**
   * ğŸ›¡ï¸ğŸ‘‘ GUARDA + ADMINISTRADORES
   */
  private async getGuardAndAdmins(
    companyId: string,
    guardId?: string,
  ): Promise<string[]> {
    const [guard, admins] = await Promise.all([
      this.getGuardOnly(guardId),
      this.getAdminsOnly(companyId),
    ]);
    return Array.from(new Set([...guard, ...admins]));
  }

  /**
   * ğŸ›¡ï¸ğŸ”„ GUARDA + SUPERVISORES ATIVOS
   */
  private async getGuardAndActiveSupervisors(
    companyId: string,
    guardId?: string,
  ): Promise<string[]> {
    const [guard, activeSupervisors] = await Promise.all([
      this.getGuardOnly(guardId),
      this.getActiveSupervisors(companyId),
    ]);
    return Array.from(new Set([...guard, ...activeSupervisors]));
  }

  private async getGuardAndActiveSupervisorsAndAdmins(
    companyId: string,
    guardId?: string,
  ): Promise<string[]> {
    const [guard, activeSupervisors, admins] = await Promise.all([
      this.getGuardOnly(guardId),
      this.getActiveSupervisors(companyId),
      this.getAdminsOnly(companyId),
    ]);
    return Array.from(new Set([...guard, ...activeSupervisors, ...admins]));
  }

  // ============================================================================
  // ğŸ”§ MÃ‰TODOS DE COMPATIBILIDADE (MANTIDOS PARA NÃƒO QUEBRAR CÃ“DIGO EXISTENTE)
  // ============================================================================

  /**
   * @deprecated Use getRecipients com RecipientType
   */
  async getAllAdminsAndSupervisorsInCompany(
    companyId: string,
  ): Promise<string[]> {
    return this.getAdminsAndSupervisors(companyId);
  }
}
