// schema_opcao2.prisma
// New schema aligned with the multi-tenant proposal and project features
// For comparison with the current schema

generator client {
  provider = "prisma-client-js"
}

generator json {
  provider = "prisma-json-types-generator"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "./ERD.svg"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// temporário, irei remover
model Post {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  published Boolean  @default(false)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String @id @default(cuid())
  name        String
  slug        String @unique
  description String
  price       Float
}

enum Roles {
  PLATFORM_ADMIN
  ADMIN
  HR
  GUARD
  RESIDENT
  SUPERVISION

  // temporário, irei remover
  EDITOR
  WRITER
  READER
}

enum PermissionAction {
  VIEW_DASHBOARD
  MANAGE_USERS
  MANAGE_UNITS
  MANAGE_ROUNDS
  VIEW_REPORTS
  EDIT_PROFILE
  // ...add others as needed
}

model Company {
  id           String   @id @default(cuid())
  name         String
  cnpj         String   @unique
  website      String?
  address      String?
  country      String?
  contactName  String?
  contactEmail String?
  contactPhone String?
  units        Unit[]
  users        User[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Unit {
  id          String       @id @default(cuid())
  name        String
  address     String?
  company      Company      @relation(fields: [companyId], references: [id])
  companyId    String
  guards      User[]       @relation("GuardsUnit")
  rounds      Round[]
  checkpoints Checkpoint[]
  shifts      Shift[]
  eventLogs   EventLog[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  panicEvents PanicEvent[]
}

model User {
  id             String       @id @default(cuid())
  name           String
  email          String       @unique
  password       String
  role           Roles
  company         Company?     @relation(fields: [companyId], references: [id])
  companyId       String?
  unit           Unit?        @relation("GuardsUnit", fields: [unitId], references: [id])
  unitId         String?
  profilePicture String?
  active         Boolean      @default(true)
  refreshToken   String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  // permissions  Permission[]
  permissions    Json?
  rounds         Round[]      @relation("UserRounds")
  shifts         Shift[]
  eventLogs      EventLog[]
  panicEvents    PanicEvent[]
  // temporário irei remover
  Post           Post[]
  @@index([companyId])
}

model Permission {
  id        String           @id @default(cuid())
  // user      User             @relation(fields: [userId], references: [id])
  // userId    String
  action    PermissionAction
  resource  String
  createdAt DateTime         @default(now())
}

model Round {
  id          String       @id @default(cuid())
  unit        Unit         @relation(fields: [unitId], references: [id])
  unitId      String
  guard       User         @relation("UserRounds", fields: [guardId], references: [id])
  guardId     String
  start       DateTime
  end         DateTime?
  status      String // started, finished, failed
  roundPoints RoundPoint[]
  createdAt   DateTime     @default(now())
}

model Checkpoint {
  id          String       @id @default(cuid())
  unit        Unit         @relation(fields: [unitId], references: [id])
  unitId      String
  name        String
  location    String?
  roundPoints RoundPoint[]
  createdAt   DateTime     @default(now())
}

model RoundPoint {
  id           String     @id @default(cuid())
  round        Round      @relation(fields: [roundId], references: [id])
  roundId      String
  checkpoint   Checkpoint @relation(fields: [checkpointId], references: [id])
  checkpointId String
  checkedAt    DateTime
  status       String // ok, failed, etc
}

model Shift {
  id       String   @id @default(cuid())
  guard    User     @relation(fields: [guardId], references: [id])
  guardId  String
  unit     Unit     @relation(fields: [unitId], references: [id])
  unitId   String
  type     String // entry, exit, check-in
  dateTime DateTime @default(now())
}

model EventLog {
  id        String   @id @default(cuid())
  unit      Unit     @relation(fields: [unitId], references: [id])
  unitId    String
  guard     User?    @relation(fields: [guardId], references: [id])
  guardId   String?
  type      String // e.g. "PANIC", "NOTE", "PHOTO", etc
  details   String?
  media     String?
  createdAt DateTime @default(now())
}

model PanicEvent {
  id         String   @id @default(cuid())
  resident   User     @relation(fields: [residentId], references: [id])
  residentId String
  unit       Unit     @relation(fields: [unitId], references: [id])
  unitId     String
  dateTime   DateTime @default(now())
  status     String // open, attended, resolved
}

// Other tables for reports, dashboards, etc, can be added as needed
